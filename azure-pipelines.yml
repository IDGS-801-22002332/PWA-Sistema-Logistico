# ==========================================
# PIPELINE CI/CD para Node.js + React (Vite)
# Proyecto: pwa-sistema-logistico
# ==========================================

trigger:
  branches:
    include:
      - dev
      - main

pool:
  vmImage: ubuntu-latest

stages:
# ======================
# 1️⃣ BUILD STAGE
# ======================
- stage: Build
  displayName: 'Build Stage'
  jobs:
  - job: BuildJob
    steps:
    - task: NodeTool@0
      inputs:
        versionSpec: '20.x'
      displayName: 'Install Node.js 20'

    - script: |
        echo "=== Node & NPM Versions ==="
        node -v
        npm -v

        echo "=== Cleaning workspace ==="
        npm cache clean --force
        rm -rf node_modules dist

        echo "=== Installing dependencies ==="
        npm install

        echo "=== Running ESLint ==="
        npm run lint || echo "Lint warnings ignored (no fail build)."

        echo "=== Building app with Vite ==="
        npm run build
      displayName: 'Install, Lint and Build App'

    - task: PublishBuildArtifacts@1
      inputs:
        PathtoPublish: 'dist'
        ArtifactName: 'drop'
      displayName: 'Publish Build Artifacts'

# ======================
# 2️⃣ TEST STAGE
# ======================
- stage: Test
  dependsOn: Build
  displayName: 'Test Stage'
  jobs:
  - job: TestJob
    steps:
    - task: NodeTool@0
      inputs:
        versionSpec: '20.x'
      displayName: 'Install Node.js 20 (for Test)'

    - script: |
        echo "=== No test script found in package.json ==="
        echo "Skipping tests..."
      displayName: 'Skip Tests (No tests defined)'

# ======================
# 3️⃣ DEPLOY STAGE (Azure App Service)
# ======================
- stage: Deploy
  dependsOn: Test
  condition: succeeded()
  displayName: 'Deploy Stage to Azure App Service'
  jobs:
  - deployment: DeployWeb
    environment: 'staging'
    strategy:
      runOnce:
        deploy:
          steps:
          - task: DownloadBuildArtifacts@1
            inputs:
              buildType: 'current'
              downloadType: 'single'
              artifactName: 'drop'
              downloadPath: '$(System.ArtifactsDirectory)/app'
            displayName: 'Download Build Artifacts'

          - task: AzureWebApp@1
            displayName: 'Deploy to Azure App Service (CRMLogistico)'
            inputs:
              azureSubscription: 'azure-devops'
              appType: 'webAppLinux'
              appName: 'CRMLogistico'
              package: '$(System.ArtifactsDirectory)/app/drop/**'


          - task: AzureCLI@2
            displayName: 'Close Linked Work Items (auto-linked by commit)'
            condition: succeeded()
            inputs:
              azureSubscription: 'azure-devops'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              addSpnToEnvironment: true
              inlineScript: |
                echo "Fetching work items linked to this pipeline run..."
                WORK_ITEMS=$(az boards query --wiql "SELECT [System.Id] FROM WorkItems WHERE [System.Links.LinkType] = 'ArtifactLink' AND [System.Title] CONTAINS '$(Build.SourceVersion)'" --org "$(System.TeamFoundationCollectionUri)" --project "$(System.TeamProject)" --output tsv || echo "")
                if [ -z "$WORK_ITEMS" ]; then
                  echo "No work items found linked to this build."
                else
                  echo "Found work items: $WORK_ITEMS"
                  for WORK_ITEM_ID in $WORK_ITEMS; do
                    echo "Closing Work Item ID: $WORK_ITEM_ID"
                    az boards work-item update --id $WORK_ITEM_ID --state "Closed" --org "$(System.TeamFoundationCollectionUri)" --project "$(System.TeamProject)"
                  done
                fi
                echo "Work item closing process finished."


# ======================
# 4️⃣ MONITOR STAGE
# ======================
- stage: Monitor
  dependsOn: Deploy
  condition: succeeded()
  displayName: 'Monitor Stage'
  jobs:
  - job: MonitorJob
    steps:
    - script: |
        echo "=== Performing health check ==="
        curl -f -I https://crmlogistico-gqembuffawgdfudk.canadacentral-01.azurewebsites.net || (echo "ERROR: Site unreachable or returned an error status" && exit 1)
        echo "Health check passed!"
      displayName: 'Check Deployment Health'
